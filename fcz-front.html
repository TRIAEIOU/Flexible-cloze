<!-- Title field at top of page -->
<div id="fcz-title" class="{{Tags}} title front">{{Title}}</div>

<!-- Main scrollable area of the screen -->
<div id="fcz-scroll-area" class="fcz-scroll-area front">

    <!-- Main content field, has to be present but can be styled/layouted differently -->
    <div id="fcz-content">{{cloze:Text}}</div>
    <div id="fcz-content-placeholder"></div>

    <!-- Additional fields, delete the divs to remove from the card -->
    <div id="fcz-additional">
        {{#Note}}
            <div id="note-header" class="additional-header">Note</div>
            <div id="note" class="additional-content">{{Note}}</div>
        {{/Note}}
        {{#Mnemonics}}
            <div id="mnemonics-header" class="additional-header">Mnemonics</div>
            <div id="mnemonics" class="additional-content">{{Mnemonics}}</div>
        {{/Mnemonics}}
        {{#Extra}}
            <div id="extra-header" class="additional-header">Extra</div>
            <div id="extra" class="additional-content">{{Extra}}</div>
        {{/Extra}}
        <div id="info-header" class="additional-header"> Information</div>
        <div id="info" class="additional-content">
            <div id="deck"><b>Deck</b>: {{Deck}}</div>
            {{#Tags}}<div id="tags"><b>Tags</b>: {{Tags}}</div>{{/Tags}}
        </div>
    </div>
    <!-- Optional "show all button" -->
    <div id="fcz-show-all-btn">Show all</div>
</div>

<!-- Footer at the bottom of the screen, delete to remove or modify/add to change -->
<div id="fcz-footer" class="front">
    <!-- Symbol legend, delete divs to remove or modify number and content of child divs -->
    <div id="fcz-legend-footer">
        <div class="fcz-legend-entry">&#8594; Becomes</div>
        <div class="fcz-legend-entry">&#8658; Leads to</div>
        <div class="fcz-legend-entry">&#10521; Excite/activate</div>
        <div class="fcz-legend-entry">&#10979; Inhibit/deactivate</div>
    </div>
    <!-- Flag legend, delete divs to remove, text and color can be set on "Styles" page -->
    <div id="fcz-flag-footer">
        <div id="fcz-flag-red" class="fcz-flag"></div>
        <div id="fcz-flag-orange" class="fcz-flag"></div>
        <div id="fcz-flag-green" class="fcz-flag"></div>
        <div id="fcz-flag-blue" class="fcz-flag"></div>
        <div id="fcz-flag-pink" class="fcz-flag"></div>
        <div id="fcz-flag-turquoise" class="fcz-flag"></div>
        <div id="fcz-flag-purple" class="fcz-flag"></div>
    </div>
</div>

<!-- Screen edge navigation controls, delete the divs to remove -->
<div id="nav-toggle-all" class="nav-area-top"></div>
<div id="nav-prev-cloze" class="nav-area-side"></div>
<div id="nav-next-cloze" class="nav-area-side"></div>

<!-- FCZ2 BEGIN [2.0] -->
<script type="application/javascript">

/* CONFIGURATION BEGIN ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓ */
var config = {
    prompt: '',            // Prompt when no hint
    hint: '%h',               // %h is replaced with hint text
    expose: {
        chars: '!',             // Char(s) to mark exposed cloze
        pos: 'begin',           // Char pos: `pre`, `begin`, `end` or `post`
        reverse: false          // If true exposed clozes are hidden, others shown
    },
    scroll: {                   // Valid values: `none`, `min`, `center` or `context`
        initial: 'chapter-context',     // Scoll on initial show
        click: 'min',           // Scroll on cloze click
        iterate: 'min'          // Scroll on iteration
    },
    iteration: {
        top: false,             // Always start iteration from top
        loop: true,             // Restart from top/bottom from end
        hide: true              // Hide cloze iterated away from
    },
    shortcuts: {
        next: 'j',              // Iterate to next cloze
        previous: 'h',          // Iterate to previous cloze
        toggle_all: 'k'         // Toggle all clozes and fields
    },
    show: {                     // `false` means initially collapsed/hidden
        inactive: false,        // Inactive clozes
        additional: false,      // Additional fields (Note, Mnemonics etc.)
        info: false             // Information field
    }
}
/* CONFIGURATION END ↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑ */

</script>
<!-- FUNCTIONALITY BEGIN -->
<script type="application/javascript">
var fcz
if (!fcz) fcz = {}
/////////////////////////////////////////////////////////////////
// Generic init done on front and back
fcz.init = () => {
    fcz.content = document.getElementById('fcz-content')
    fcz.viewport = document.getElementById('fcz-scroll-area')
    if (!fcz.ordinal)
        fcz.ordinal = parseInt(document.querySelector('span.cloze').dataset.ordinal)
    fcz.exposed = fcz.generate_exposed()

    // Generic: setup inactive clozes
    fcz.content.querySelectorAll('span.cloze-inactive').forEach(span => {
        if (fcz.exposed(span) || span.querySelector('span.cloze'))
            span.classList.remove('cloze-inactive')
        else if (!fcz.cfg.show.inactive) fcz.hide(span)
    })

    // Generic: show additional fields per default depending on config
    if (fcz.cfg.show.additional)
        fcz.viewport.querySelectorAll(':not(#info).additional-content')
        .forEach(nd => { nd.style.display = 'block' })

    // Generic: show info field per default depending on config
    if (fcz.cfg.show.info)
        document.querySelector('div#info.additional-content')
        .style.display = 'block'

    // Generic: reveal finished content, hide placeholder and scroll to first active cloze
    fcz.content.style.display = 'block'
    document.getElementById('fcz-content-placeholder').style.display = 'none'
    fcz.current = null

    // Setup event handlers if not already done
    if (!fcz.init_done) {
        fcz.init_done = true
        document.addEventListener("click", (evt) => {
            // Cloze click handling
            if (evt.target.classList.contains('cloze')
                || evt.target.classList.contains('cloze-inactive')) {
                    evt.stopPropagation() // To avoid toggling parents
                    if (!fcz.cfg.iteration.top) fcz.current = evt.target
                    fcz.toggle(evt.target)
                    fcz.scroll_to(fcz.cfg.scroll.click, evt.target)
            // Additional content (header and actual content)
            } else if (evt.target.classList.contains('additional-header'))
                fcz.toggle_field(evt.target.firstElementChild)
            else if (evt.target.classList.contains('additional-content'))
                fcz.toggle_field(evt.target)
            // Toggle all button
            else if (evt.target.id === 'fcz-show-all-btn') fcz.toggle_all()
            // Nav bars
            else if (evt.target.id === 'nav-toggle-all') fcz.toggle_all()
            else if (evt.target.id === 'nav-prev-cloze') fcz.iter(false)
            else if (evt.target.id === 'nav-next-cloze') fcz.iter(true)
        })

        document.addEventListener("keydown", (evt) => {
            if (evt.key === fcz.cfg.shortcuts.next) {
                fcz.iter(true)
                evt.preventDefault()
            } else if (evt.key === fcz.cfg.shortcuts.previous) {
                fcz.iter(false)
                evt.preventDefault()
            } else if (evt.key === fcz.cfg.shortcuts.toggle_all) {
                fcz.toggle_all()
                evt.preventDefault()
            }
        })
    }

    fcz.scroll_to(fcz.cfg.scroll.initial)
}

/////////////////////////////////////////////////////////////////
// Create exposed function from config
fcz.generate_exposed = () => {
    let exposed_
    if (fcz.cfg.expose.pos === 'pre')
        exposed_ = (el) => {return el.previousSibling.wholeText?.endsWith(fcz.cfg.expose.chars)}
    else if (fcz.cfg.expose.pos === 'end')
        exposed_ = (el) => {return el.innerHTML.endsWith(fcz.cfg.expose.chars)}
    else if (fcz.cfg.expose.pos === 'post')
        exposed_ = (el) => {return el.nextSibling.wholeText?.startsWith(fcz.cfg.expose.chars)}
    else // fcz.cfg.expose.pos === 'begin'
        exposed_ = (el) => {return el.innerHTML.startsWith(fcz.cfg.expose.chars)}
    return fcz.cfg.expose.reverse ? (el) => {return !exposed_(el)} : exposed_
}

/////////////////////////////////////////////////////////////////
// Hide cloze (and save cloze content as needed)
fcz.hide = (self) => {
    if (self.dataset.cloze === undefined) self.dataset.cloze = self.innerHTML
    self.classList.add('hide')
    self.innerHTML = fcz.get_hint(self)
}

/////////////////////////////////////////////////////////////////
// Show cloze (and save cloze hint as needed)
fcz.show = (self) => {
    if (self.dataset.hint === undefined) self.dataset.hint = fcz.get_hint(self)
    self.classList.remove('hide')
    self.innerHTML = self.dataset.cloze
}

/////////////////////////////////////////////////////////////////
// Get cloze hint (and save to dataset as needed)
fcz.get_hint = (self) => {
    if (self.dataset.hint === undefined) {
        if (fcz.cfg.hasOwnProperty('prompt')
            && (self.innerHTML === '[...]' || self.classList.contains('cloze-inactive')))
                self.dataset.hint = fcz.cfg.prompt
        else if (fcz.cfg.hasOwnProperty('hint') && self.innerHTML !== '[...]')
            self.dataset.hint = fcz.cfg.hint.replace('%h', self.innerHTML.slice(1, -1))
        else
            self.dataset.hint = '[...]'
    }
    return self.dataset.hint
}

/////////////////////////////////////////////////////////////////
// Toggle cloze state
fcz.toggle_cloze = (self) => {
    if (span.classList.contains('hide')) fcz.show(self)
    else fcz.hide(self)
}

/////////////////////////////////////////////////////////////////
// Toggle additional field state
fcz.toggle_field = (self) => {
    self.style.display = self.style.display === 'none' ? 'block' : 'none'
}

/////////////////////////////////////////////////////////////////
// Toggle all clozes and fields, sync towards show
fcz.toggle_all = () => {
    if (fcz.content.querySelector('span.cloze.hide, span.cloze-inactive.hide'))
        fcz.content.querySelectorAll('span.cloze.hide, span.cloze-inactive.hide')
        .forEach(el => { fcz.show(el) })
    else
        fcz.content.querySelectorAll('span.cloze:not(.hide), span.cloze-inactive:not(.hide)')
        .forEach(el => { fcz.hide(el) })
}

/////////////////////////////////////////////////////////////////
// Iterate forward or backward
fcz.iter = (fwd) => {
    const els = fcz.content.querySelectorAll('span.cloze');
    let nxt
    const end = fwd ? els.slice(-1) : els[0]
    if (fcz.current === (fwd ? els.slice(-1) : els[0]))
        if (!fcz.cfg.iteration.loop) return
        else nxt = fwd ? els[0] : els.slice(-1)
    for (let i = 1; !nxt && i < els.length; i++)
        if (els[i] === fcz.current) nxt = els[i + fwd ? 1 : -1]
    if (fcz.cfg.iteration.hide) fcz.hide(fcz.current)
    fcz.show(fcz.current = nxt)
    scroll_to(fcz.cfg.scroll.iterate, fcz.current)
}

/////////////////////////////////////////////////////////////////
// Scroll to active clozes or specific cloze
fcz.scroll_to = (scroll, self = null) => {
    if (scroll === 'none') return
    let first, last
    if (self) first = last = self
    else {
        const active = fcz.content.querySelectorAll('span.cloze')
        first = active[0]
        last = active[active.length - 1]
    }

    const top = first.getBoundingClientRect().top + fcz.viewport.scrollTop -  fcz.viewport.offsetTop
    const bottom = last.getBoundingClientRect().bottom + fcz.viewport.scrollTop - fcz.viewport.offsetTop
    const middle = (fcz.viewport.offsetHeight - (bottom - top)) / 2
    const center = top - middle
    let y = 0

    // Context scroll, either from preceeding or HR/HX
    if (scroll.slice(-7) === 'context') {
        const all = fcz.content.querySelectorAll('span.cloze, span.cloze-inactive')
        for (let i = 1; i < all.length; i++)
            if (all[i] === first) {
                y = Math.min(prev.getBoundingClientRect().bottom + fcz.viewport.scrollTop - fcz.viewport.offsetTop, center)
                break
            }
        if (scroll === 'chapter-context') {
            let sep
            for (nd of fcz.content.querySelectorAll('hr, h1, h2, h3, h4, h5, h6, span.cloze')) {
                if (nd.tagName === 'SPAN') break
                sep = nd
            }
            if (sep) {
                const border = sep.tagName === 'HR'
                    ? sep.getBoundingClientRect().bottom
                    : sep.getBoundingClientRect().top + 5
                y = Math.min(y, border + fcz.viewport.scrollTop - fcz.viewport.offsetTop)
            } else if (fcz.content.querySelector('hr, h1, h2, h3, h4, h5, h6'))
                y = fcz.viewport.scrollTop - fcz.viewport.offsetTop
            // else y is already set to prev.bottom or center
        }
    }
    else if (bottom - top >= fcz.viewport.offsetHeight)
        // All clozes will not fit - scroll to first at top regardless
        y = top - line_height(window.getComputedStyle(first.previousElementSibling ? first.previousElementSibling : first, ':before'))
    else if (scroll === 'center') y = center
    // scroll === 'min'
    else y = bottom - fcz.viewport.offsetHeight + line_height(window.getComputedStyle(last.nextElementSibling
            ? last.nextElementSibling
            : last,
        ':after'))
    fcz.viewport.scrollTo(0, y)

    function line_height(style) {
        let lh
        if (style.lineHeight.toLowerCase() === "normal") {
            var nd = document.createElement('span')
            nd.innerHTML = '&nbsp;'
            nd.style = style
            nd.style.border = '0px'
            nd.style.margin = '0px'
            nd.style.padding = '0px'
            fcz.content.appendChild(nd)
            lh = nd.offsetHeight
            fcz.content.removeChild(nd)
        }
        if (!lh) lh = parseInt(style.lineHeight) || 20
        return lh
    }
}

// Side specific initializations
fcz.cfg = config
// Change active prompt if needed
var custom_prompt = fcz.cfg.prompt !== '[...]' || fcz.cfg.hint !== '[%h]'
document.body.querySelectorAll('span.cloze').forEach(span => {
    span.classList.add('hide') // starts as hidden
    if (custom_prompt) span.innerHTML = fcz.get_hint(span)
})

// Run generic initialization
fcz.init()
</script>
<!-- FUNCTIONALITY END -->
<!-- FCZ2 END -->